# Define the build version
version: 6.1.0.{build}

# Select the worker image
image: Visual Studio 2022

# scripts that run after cloning repository
#install:
#  - ps: Install-Module -Name SignPath
#  - ps: Install-Module -Name PowerShellForGitHub 
#  - cmd: choco install gh
  


# Fake build script
build_script: 
  - ps:  write-host "This step would build the artifact in build-output/odata2poco-v6.1.0.zip"
  - ps:  write-host "APPVEYOR_JOB_ID      = $Env:APPVEYOR_JOB_ID$"
  - ps:  write-host " APPVEYOR_JOB_NAME   = $Env:APPVEYOR_JOB_NAME$"
  - ps:  write-host " APPVEYOR_JOB_NUMBER = $Env:APPVEYOR_JOB_NUMBER$" 
  - ps: Write-host "SIGNPATH_SIGNING_REQUESt_ID= $($env:SIGNPATH_SIGNING_REQUEST_ID)"
  - ps: Write-host "SIGNPATH_SIGNING_REQUEST_STATUS= $($env:SIGNPATH_SIGNING_REQUEST_STATUS)"

    
  
# Definition of artifacts
artifacts:
  - path: build-output\odata2poco-v6.1.0.zip
  - path: build-output\sr.txt

# Set the signing policy slug according to branch
environment:
  VERSION: v6.1.0
  SIGNPATH_SIGNING_REQUEST_ID : ""
  SIGNPATH_SIGNING_POLICY_SLUG: test-signing
  ARTIFACT_CONFIGURATION_SLUG: o2p2
  SIGNPATH_PROJECT_SLUG : odata2poco  
  SIGNPATH_ORGANIZATION_ID : 783237d7-f6db-4caa-b64e-a3fc87156006
  SIGNPATH_SIGNING_REQUEST_STATUS : $SigningRequestStatus$
  SIGNPATH_CI_USER_TOKEN:
    secure: fkMRmkT0HDBDna85gU5hTJnS4G7brD0xoc7YAtD001hqlRSgI4hCyCMtbeJZOYT1
  SKIP_TESTS: true  

for:
  -
    branches:
      only:
        - sign-code
        - master
    environment:
      SIGNPATH_SIGNING_POLICY_SLUG: test-signing


deploy:
  - provider: Webhook
    url: https://app.signpath.io/API/v1/%SIGNPATH_ORGANIZATION_ID%/Integrations/AppVeyor?ProjectSlug=%SIGNPATH_PROJECT_SLUG%&SigningPolicySlug=%SIGNPATH_SIGNING_POLICY_SLUG%&ArtifactConfigurationSlug=%ARTIFACT_CONFIGURATION_SLUG%
    authorization: 'Bearer %SIGNPATH_CI_USER_TOKEN%'
    request_timeout: 5

after_deploy:
  - ps: |
      # Start-Sleep -Seconds 90
      if ($($Env:SIGNPATH_SIGNING_REQUEST_ID) -ne '') {
       # Write-Output $env:SIGNING_REQUEST_ID > rd.txt
       $Env:SIGNPATH_SIGNING_REQUEST_ID | Set-Content "build-output\sr.txt"
      }
      Write-host "SIGNPATH_SIGNING_REQUESt_ID= $($env:SIGNPATH_SIGNING_REQUEST_ID)"
      Write-host "SIGNPATH_SIGNING_REQUEST_STATUS= $($env:SIGNPATH_SIGNING_REQUEST_STATUS)"

# init:
#  - ps: iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
  
#  on_finish:
# - ps: $blockRdp = $true; iex ((new-object  net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))

on_finish:
    - ps: |
       Write-host "SIGNPATH_SIGNING_REQUESt_ID= $($env:SIGNPATH_SIGNING_REQUEST_ID)"
       Write-host "SIGNPATH_SIGNING_REQUEST_STATUS= $($env:SIGNPATH_SIGNING_REQUEST_STATUS)"
       
  